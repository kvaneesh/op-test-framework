
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>common.OpTestSystem &#8212; op-test-framework pre-v1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for common.OpTestSystem</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python2</span>
<span class="c1"># IBM_PROLOG_BEGIN_TAG</span>
<span class="c1"># This is an automatically generated prolog.</span>
<span class="c1">#</span>
<span class="c1"># $Source: op-test-framework/common/OpTestSystem.py $</span>
<span class="c1">#</span>
<span class="c1"># OpenPOWER Automated Test Project</span>
<span class="c1">#</span>
<span class="c1"># Contributors Listed Below - COPYRIGHT 2015,2017</span>
<span class="c1"># [+] International Business Machines Corp.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or</span>
<span class="c1"># implied. See the License for the specific language governing</span>
<span class="c1"># permissions and limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># IBM_PROLOG_END_TAG</span>

<span class="c1">## @package OpTestSystem</span>
<span class="c1">#  System package for OpenPower testing.</span>
<span class="c1">#</span>
<span class="c1">#  This class encapsulates all interfaces and classes required to do end to end</span>
<span class="c1">#  automated flashing and testing of OpenPower systems.</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">pexpect</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">commands</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">import</span> <span class="nn">OpTestIPMI</span> <span class="c1"># circular dependencies, use package</span>
<span class="kn">import</span> <span class="nn">OpTestQemu</span>
<span class="kn">import</span> <span class="nn">OpTestMambo</span>
<span class="kn">from</span> <span class="nn">OpTestFSP</span> <span class="k">import</span> <span class="n">OpTestFSP</span>
<span class="kn">from</span> <span class="nn">OpTestConstants</span> <span class="k">import</span> <span class="n">OpTestConstants</span> <span class="k">as</span> <span class="n">BMC_CONST</span>
<span class="kn">from</span> <span class="nn">OpTestError</span> <span class="k">import</span> <span class="n">OpTestError</span>
<span class="kn">import</span> <span class="nn">OpTestHost</span>
<span class="kn">from</span> <span class="nn">OpTestUtil</span> <span class="k">import</span> <span class="n">OpTestUtil</span>
<span class="kn">from</span> <span class="nn">OpTestSSH</span> <span class="k">import</span> <span class="n">ConsoleState</span> <span class="k">as</span> <span class="n">SSHConnectionState</span>
<span class="kn">from</span> <span class="nn">Exceptions</span> <span class="k">import</span> <span class="n">HostbootShutdown</span><span class="p">,</span> <span class="n">WaitForIt</span><span class="p">,</span> <span class="n">RecoverFailed</span><span class="p">,</span> <span class="n">UnknownStateTransition</span>
<span class="kn">from</span> <span class="nn">Exceptions</span> <span class="k">import</span> <span class="n">ConsoleSettings</span><span class="p">,</span> <span class="n">UnexpectedCase</span><span class="p">,</span> <span class="n">StoppingSystem</span><span class="p">,</span> <span class="n">HTTPCheck</span>
<span class="kn">from</span> <span class="nn">OpTestSSH</span> <span class="k">import</span> <span class="n">OpTestSSH</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">OpTestLogger</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">OpTestLogger</span><span class="o">.</span><span class="n">optest_logger_glob</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="OpSystemState"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpSystemState">[docs]</a><span class="k">class</span> <span class="nc">OpSystemState</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class is used as an enum as to what state op-test *thinks* the host is in.</span>
<span class="sd">    These states are used to drive a state machine in OpTestSystem.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">OFF</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">IPLing</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">PETITBOOT</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">PETITBOOT_SHELL</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">BOOTING</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">OS</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">POWERING_OFF</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">UNKNOWN_BAD</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># special case, use set_state to place system in hold for later goto</span></div>

<div class="viewcode-block" id="OpTestSystem"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem">[docs]</a><span class="k">class</span> <span class="nc">OpTestSystem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1">## Initialize this object</span>
    <span class="c1">#  @param i_bmcIP The IP address of the BMC</span>
    <span class="c1">#  @param i_bmcUser The userid to log into the BMC with</span>
    <span class="c1">#  @param i_bmcPasswd The password of the userid to log into the BMC with</span>
    <span class="c1">#  @param i_bmcUserIpmi The userid to issue the BMC IPMI commands with</span>
    <span class="c1">#  @param i_bmcPasswdIpmi The password of BMC IPMI userid</span>
    <span class="c1">#</span>
    <span class="c1"># &quot;Only required for inband tests&quot; else Default = None</span>
    <span class="c1"># @param i_hostIP The IP address of the Host</span>
    <span class="c1"># @param i_hostuser The userid to log into the Host</span>
    <span class="c1"># @param i_hostPasswd The password of the userid to log into the host with</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">bmc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">prompt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">conf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">state</span><span class="o">=</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">util</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">util</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bmc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_BMC</span> <span class="o">=</span> <span class="n">bmc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span> <span class="o">=</span> <span class="n">bmc</span><span class="o">.</span><span class="n">get_ipmi</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bmc</span><span class="o">.</span><span class="n">get_rest_api</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bmc</span><span class="o">.</span><span class="n">get_host_console</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">prompt</span> <span class="c1"># build_prompt located in OpTestUtil</span>
        <span class="c1"># system console state tracking, reset on boot and state changes, set when valid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PS1_set</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SUDO_set</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOGIN_set</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expect_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">build_prompt</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_state</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># used for PS1, LOGIN, SUDO state tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_state</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># used in WaitForIt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detect_counter</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># outside scope of detection to prevent loops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">never_rebooted</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># outside scope to prevent loops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">openpower</span> <span class="o">=</span> <span class="s1">&#39;openpower&#39;</span> <span class="c1"># string to define petitboot kernel cat /proc/version column 3, change if using debug petitboot kernel</span>

        <span class="c1"># dictionary used in sorted order</span>
        <span class="c1"># column 1 is the string, column 2 is the action</span>
        <span class="c1"># normally None is the action, otherwise a handler mostly used for exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_expect_table</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s1">&#39;Petitboot&#39;</span>                              <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
          <span class="s1">&#39;/ #&#39;</span>                                    <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
          <span class="s1">&#39;shutdown requested&#39;</span>                     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostboot_callback</span><span class="p">,</span>
          <span class="s1">&#39;x=exit&#39;</span>                                 <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
          <span class="s1">&#39;login: &#39;</span>                                <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">login_callback</span><span class="p">,</span>
          <span class="s1">&#39;mon&gt; &#39;</span>                                  <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmon_callback</span><span class="p">,</span>
          <span class="s1">&#39;System shutting down with error status&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">guard_callback</span><span class="p">,</span>
          <span class="s1">&#39;Aborting!&#39;</span>                              <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">skiboot_callback</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">login_expect_table</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s1">&#39;login: &#39;</span>                           <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
          <span class="s1">&#39;/ #&#39;</span>                               <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_callback</span><span class="p">,</span>
          <span class="s1">&#39;mon&gt; &#39;</span>                             <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmon_callback</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># tunables for customizations, put them here all together</span>

        <span class="c1"># ipmi versus ssh settings, sometimes tuning is needed based on type, so keeping split for tuning</span>
        <span class="c1"># to basically turn off reconnect based on stale buffers set threshold equal to watermark, e.g. 100</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span> <span class="n">OpTestIPMI</span><span class="o">.</span><span class="n">IPMIConsole</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">threshold_petitboot</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1"># stale buffer check</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">threshold_login</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1"># long enough to skip the refresh until kexec, stale buffers need to be jumped over</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_kicker</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_refresh</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># petitboot menu cannot tolerate, cancels default boot</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_reconnect</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">login_refresh</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">login_reconnect</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># less reliable connections, ipmi act/deact does not trigger default boot cancel</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">login_fresh_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">threshold_petitboot</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1"># stale buffer check</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">threshold_login</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1"># long enough to skip the refresh until kexec, stale buffers need to be jumped over</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_kicker</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_refresh</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># petitboot menu cannot tolerate, cancels default boot</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_reconnect</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># NEW ssh triggers default boot cancel, just saying</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">login_refresh</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">login_reconnect</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># NEW ssh triggers default boot cancel, just saying</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">login_fresh_start</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># watermark is the loop counter (loop_max) used in conjunction with timeout</span>
        <span class="c1"># timeout is the expect timeout for each iteration</span>
        <span class="c1"># watermark will automatically increase in case the loop is too short</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipl_watermark</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipl_timeout</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># needs consideration with petitboot timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">booting_watermark</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">booting_timeout</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kill_cord</span> <span class="o">=</span> <span class="mi">150</span> <span class="c1"># just a ceiling on giving up</span>

        <span class="c1"># We have a state machine for going in between states of the system</span>
        <span class="c1"># initially, everything in UNKNOWN, so we reset things.</span>
        <span class="c1"># UNKNOWN is used to flag the system to auto-detect the state if</span>
        <span class="c1"># possible to efficiently achieve state transitions.</span>
        <span class="c1"># But, we allow setting an initial state if you, say, need to</span>
        <span class="c1"># run against an already IPLed system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span><span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_UNKNOWN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span><span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">OFF</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_OFF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span><span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">IPLing</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_IPLing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span><span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_PETITBOOT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span><span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_PETITBOOT_SHELL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span><span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">BOOTING</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_BOOTING</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span><span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_OS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span><span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">POWERING_OFF</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_POWERING_OFF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span><span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN_BAD</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_UNKNOWN</span>

        <span class="c1"># We track the state of loaded IPMI modules here, that way</span>
        <span class="c1"># we only need to try the modprobe once per IPL.</span>
        <span class="c1"># We reset as soon as we transition away from OpSystemState.OS</span>
        <span class="c1"># a TODO is to support doing this in petitboot shell as well.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipmiDriversLoaded</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="OpTestSystem.hostboot_callback"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.hostboot_callback">[docs]</a>    <span class="k">def</span> <span class="nf">hostboot_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;my_r&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_vals</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN_BAD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">raise</span> <span class="n">HostbootShutdown</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestSystem.login_callback"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.login_callback">[docs]</a>    <span class="k">def</span> <span class="nf">login_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;my_r&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_vals</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> *** OpTestSystem found the login prompt </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> but this is unexpected, we will retry</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
        <span class="c1"># raise the WaitForIt exception to be bubbled back to recycle early rather than having to wait the full loop_max</span>
        <span class="k">raise</span> <span class="n">WaitForIt</span><span class="p">(</span><span class="n">expect_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petitboot_expect_table</span><span class="p">,</span> <span class="n">reconnect_count</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpTestSystem.petitboot_callback"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.petitboot_callback">[docs]</a>    <span class="k">def</span> <span class="nf">petitboot_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;my_r&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_vals</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> *** OpTestSystem found the petitboot prompt </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> but this is unexpected, we will retry</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
        <span class="c1"># raise the WaitForIt exception to be bubbled back to recycle early rather than having to wait the full loop_max</span>
        <span class="k">raise</span> <span class="n">WaitForIt</span><span class="p">(</span><span class="n">expect_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">login_expect_table</span><span class="p">,</span> <span class="n">reconnect_count</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpTestSystem.guard_callback"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.guard_callback">[docs]</a>    <span class="k">def</span> <span class="nf">guard_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;my_r&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_vals</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_sel_elist</span><span class="p">(</span><span class="n">dump</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">guard_exception</span> <span class="o">=</span> <span class="n">UnexpectedCase</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;We hit the guard_callback value=</span><span class="si">{}</span><span class="s2">, manually restart the system&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN_BAD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">raise</span> <span class="n">guard_exception</span></div>

<div class="viewcode-block" id="OpTestSystem.xmon_callback"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.xmon_callback">[docs]</a>    <span class="k">def</span> <span class="nf">xmon_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;my_r&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_vals</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">xmon_check_r</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;my_r&#39;</span><span class="p">]</span>
        <span class="n">xmon_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="s2">&quot;.*mon&gt; &quot;</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">xmon_backtrace</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">after</span>
        <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="s2">&quot;.*mon&gt; &quot;</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">xmon_registers</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">after</span>
        <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="s2">&quot;.*mon&gt; &quot;</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">xmon_special_registers</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">after</span>
        <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="s2">&quot;.*mon&gt; &quot;</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">xmon_exception_registers</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">after</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_sel_elist</span><span class="p">(</span><span class="n">dump</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">my_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;We hit the xmon_callback with </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1"> backtrace=</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39; registers=</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1"> special_registers=</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39; exception_registers=</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xmon_value</span><span class="p">,</span>
                  <span class="n">xmon_backtrace</span><span class="p">,</span>
                  <span class="n">xmon_registers</span><span class="p">,</span>
                  <span class="n">xmon_special_registers</span><span class="p">,</span>
                  <span class="n">xmon_exception_registers</span><span class="p">))</span>
        <span class="n">xmon_exception</span> <span class="o">=</span> <span class="n">UnexpectedCase</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">my_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN_BAD</span>
        <span class="k">raise</span> <span class="n">xmon_exception</span></div>

<div class="viewcode-block" id="OpTestSystem.skiboot_callback"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.skiboot_callback">[docs]</a>    <span class="k">def</span> <span class="nf">skiboot_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;my_r&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_vals</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_sel_elist</span><span class="p">(</span><span class="n">dump</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">skiboot_exception</span> <span class="o">=</span> <span class="n">UnexpectedCase</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;We hit the skiboot_callback value=</span><span class="si">{}</span><span class="s2">, manually restart the system&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN_BAD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">raise</span> <span class="n">skiboot_exception</span></div>

<div class="viewcode-block" id="OpTestSystem.skiboot_log_on_console"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.skiboot_log_on_console">[docs]</a>    <span class="k">def</span> <span class="nf">skiboot_log_on_console</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="OpTestSystem.has_host_accessible_eeprom"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.has_host_accessible_eeprom">[docs]</a>    <span class="k">def</span> <span class="nf">has_host_accessible_eeprom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="OpTestSystem.has_host_led_support"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.has_host_led_support">[docs]</a>    <span class="k">def</span> <span class="nf">has_host_led_support</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OpTestSystem.has_centaurs_in_dt"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.has_centaurs_in_dt">[docs]</a>    <span class="k">def</span> <span class="nf">has_centaurs_in_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">proc_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">()</span><span class="o">.</span><span class="n">host_get_proc_gen</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">proc_gen</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;POWER9&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="OpTestSystem.has_mtd_pnor_access"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.has_mtd_pnor_access">[docs]</a>    <span class="k">def</span> <span class="nf">has_mtd_pnor_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="OpTestSystem.disable_stty_echo"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.disable_stty_echo">[docs]</a>    <span class="k">def</span> <span class="nf">disable_stty_echo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OpTestSystem.host"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.host">[docs]</a>    <span class="k">def</span> <span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span></div>

<div class="viewcode-block" id="OpTestSystem.bmc"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.bmc">[docs]</a>    <span class="k">def</span> <span class="nf">bmc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_BMC</span></div>

<div class="viewcode-block" id="OpTestSystem.rest"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.rest">[docs]</a>    <span class="k">def</span> <span class="nf">rest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span></div>

<div class="viewcode-block" id="OpTestSystem.ipmi"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.ipmi">[docs]</a>    <span class="k">def</span> <span class="nf">ipmi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span></div>

<div class="viewcode-block" id="OpTestSystem.get_state"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.get_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">;</span></div>

<div class="viewcode-block" id="OpTestSystem.set_state"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></div>

<div class="viewcode-block" id="OpTestSystem.goto_state"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.goto_state">[docs]</a>    <span class="k">def</span> <span class="nf">goto_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c1"># only perform detection when incoming state is UNKNOWN</span>
        <span class="c1"># if user overrides from command line and machine not at desired state can lead to exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># block in case the system is not on/up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_state</span> <span class="o">=</span> <span class="n">state</span> <span class="c1"># used in WaitForIt</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span> <span class="n">OpTestQemu</span><span class="o">.</span><span class="n">QemuConsole</span><span class="p">)</span> \
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span> <span class="n">OpTestMambo</span><span class="o">.</span><span class="n">MamboConsole</span><span class="p">))</span> \
            <span class="ow">and</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span><span class="p">):</span>
          <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;OpTestSystem running QEMU/Mambo so skipping OpSystemState.OS test&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">):</span>
          <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpTestSystem CHECKING CURRENT STATE and TRANSITIONING for TARGET STATE: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="p">))</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_DETECT</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
          <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpTestSystem CURRENT DETECTED STATE: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpTestSystem START STATE: </span><span class="si">%s</span><span class="s2"> (target </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
        <span class="n">never_unknown</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
              <span class="k">raise</span> <span class="n">StoppingSystem</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># block until we are clear, exceptions can re-enter while booting</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">:</span>
                <span class="n">never_unknown</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stateHandlers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">](</span><span class="n">state</span><span class="p">)</span>
            <span class="c1"># transition from states invalidate the previous PS1 setting, so clear it</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_state</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">clear_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OpTestSystem TRANSITIONED TO: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span><span class="p">:</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">if</span> <span class="n">never_unknown</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span>
                 <span class="k">raise</span> <span class="n">UnknownStateTransition</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                         <span class="n">message</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;OpTestSystem something set the system to UNKNOWN,&quot;</span>
                           <span class="s2">&quot; check the logs for details, we will be stopping the system&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="OpTestSystem.run_DETECT"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.run_DETECT">[docs]</a>    <span class="k">def</span> <span class="nf">run_DETECT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detect_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">detect_state</span> <span class="o">=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_counter</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">detect_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detect_counter</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">):</span>
          <span class="c1"># two phases</span>
          <span class="n">detect_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_target</span><span class="p">(</span><span class="n">target_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">never_rebooted</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># block after check_kernel unblocked</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">never_rebooted</span> <span class="o">=</span> <span class="kc">False</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">detect_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">detect_state</span></div>

<div class="viewcode-block" id="OpTestSystem.detect_target"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.detect_target">[docs]</a>    <span class="k">def</span> <span class="nf">detect_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_state</span><span class="p">,</span> <span class="n">reboot</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># unblock to allow setup_term during get_console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">enable_setup_term_quiet</span><span class="p">()</span>
        <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">disable_setup_term_quiet</span><span class="p">()</span>
        <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="s2">&quot;x=exit&quot;</span><span class="p">,</span> <span class="s2">&quot;Petitboot&quot;</span><span class="p">,</span> <span class="s2">&quot;.*#&quot;</span><span class="p">,</span> <span class="s2">&quot;.*\$&quot;</span><span class="p">,</span> <span class="s2">&quot;login:&quot;</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">target_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span>
          <span class="k">elif</span> <span class="p">(</span><span class="n">target_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_exit_to_shell</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span>
          <span class="k">elif</span> <span class="p">(</span><span class="n">target_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span><span class="p">)</span> <span class="ow">and</span> <span class="n">reboot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_exit_to_shell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_REBOOT</span><span class="p">(</span><span class="n">target_state</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="k">elif</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
          <span class="n">detect_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_kernel</span><span class="p">()</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">detect_state</span> <span class="o">==</span> <span class="n">target_state</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_state</span> <span class="o">=</span> <span class="n">detect_state</span> <span class="c1"># preserve state</span>
            <span class="k">return</span> <span class="n">detect_state</span>
          <span class="k">elif</span> <span class="n">reboot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span><span class="p">]:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">run_REBOOT</span><span class="p">(</span><span class="n">target_state</span><span class="p">)</span>
              <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
            <span class="k">elif</span> <span class="n">target_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span><span class="p">]:</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">detect_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit_petitboot_shell</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_REBOOT</span><span class="p">(</span><span class="n">target_state</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
            <span class="k">elif</span> <span class="n">target_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">]:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">run_REBOOT</span><span class="p">(</span><span class="n">target_state</span><span class="p">)</span>
              <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">detect_state</span> <span class="o">==</span> <span class="n">target_state</span><span class="p">):</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">previous_state</span> <span class="o">=</span> <span class="n">detect_state</span> <span class="c1"># preserve state</span>
              <span class="k">return</span> <span class="n">detect_state</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">detect_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">target_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span><span class="p">):</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">exit_petitboot_shell</span><span class="p">()</span>
              <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span>
            <span class="k">elif</span> <span class="n">target_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">]:</span>
              <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="k">elif</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">target_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span>
          <span class="k">elif</span> <span class="n">reboot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span><span class="p">,</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span><span class="p">,</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">]:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">run_REBOOT</span><span class="p">(</span><span class="n">target_state</span><span class="p">)</span>
              <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">6</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">detect_counter</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span></div>

<div class="viewcode-block" id="OpTestSystem.check_kernel"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.check_kernel">[docs]</a>    <span class="k">def</span> <span class="nf">check_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># unblock to allow setup_term during get_console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">enable_setup_term_quiet</span><span class="p">()</span>
        <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">disable_setup_term_quiet</span><span class="p">()</span>
        <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="s2">&quot;x=exit&quot;</span><span class="p">,</span> <span class="s2">&quot;Petitboot&quot;</span><span class="p">,</span> <span class="s2">&quot;.*#&quot;</span><span class="p">,</span> <span class="s2">&quot;.*\$&quot;</span><span class="p">,</span> <span class="s2">&quot;login:&quot;</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]:</span>
          <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span> <span class="c1"># we really should not have arrived in here and not much we can do</span>
        <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;cat /proc/version | cut -d &#39; &#39; -f 3 | grep </span><span class="si">%s</span><span class="s2">; echo $?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openpower</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">expect_prompt</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">echo_output</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">before</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">echo_rc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">echo_output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
          <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># most likely cause is running while booting unknowlingly</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">echo_rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_state</span> <span class="o">=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span>
          <span class="k">elif</span> <span class="n">echo_rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_state</span> <span class="o">=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># TIMEOUT EOF from cat</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span></div>

<div class="viewcode-block" id="OpTestSystem.wait_for_it"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.wait_for_it">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_it</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;expect_dict&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;refresh&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;buffer_kicker&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;loop_max&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;reconnect&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fresh_start&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;last_try&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_vals</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">base_seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">]</span>
        <span class="n">expect_seq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">base_seq</span><span class="p">)</span> <span class="c1"># we want a *copy*</span>
        <span class="n">expect_seq</span> <span class="o">=</span> <span class="n">expect_seq</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;expect_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fresh_start&#39;</span><span class="p">]:</span>
          <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="c1"># new connect gets new pexpect buffer, stale buffer from power off can linger</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span> <span class="c1"># cannot tolerate new connect on transition from 3/4 to 6</span>
        <span class="c1"># we do not perform buffer_kicker here since it can cause changes to things like the petitboot menu and default boot</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;refresh&#39;</span><span class="p">]:</span>
          <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendcontrol</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span>
        <span class="n">previous_before</span> <span class="o">=</span> <span class="s1">&#39;emptyfirst&#39;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">reconnect_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">timeout_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;loop_max&#39;</span><span class="p">]):</span>
            <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span> <span class="c1"># preemptive in case EOF came</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">expect_seq</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">])</span>
            <span class="c1"># if we have a stale buffer and we are still timing out</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">previous_before</span> <span class="o">==</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">before</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base_seq</span><span class="p">))):</span>
              <span class="n">timeout_count</span> <span class="o">+=</span> <span class="mi">1</span>
              <span class="c1"># only attempt reconnect if we&#39;ve timed out per threshold</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">timeout_count</span> <span class="o">%</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;reconnect&#39;</span><span class="p">]:</span>
                  <span class="n">reconnect_count</span> <span class="o">+=</span> <span class="mi">1</span>
                  <span class="k">try</span><span class="p">:</span>
                    <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;refresh&#39;</span><span class="p">]:</span>
                    <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendcontrol</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;buffer_kicker&#39;</span><span class="p">]:</span>
                    <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">previous_before</span> <span class="o">=</span> <span class="s1">&#39;emptyagain&#39;</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">previous_before</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">before</span>
              <span class="n">timeout_count</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">working_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_it</span><span class="p">(</span><span class="n">my_r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">check_base_seq</span><span class="o">=</span><span class="n">base_seq</span><span class="p">,</span> <span class="n">check_expect_seq</span><span class="o">=</span><span class="n">expect_seq</span><span class="p">,</span> <span class="n">check_expect_dict</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;expect_dict&#39;</span><span class="p">])</span>
            <span class="c1"># if we found a hit on the callers string return it, otherwise keep looking</span>
            <span class="k">if</span> <span class="n">working_r</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
              <span class="k">return</span> <span class="n">working_r</span><span class="p">,</span> <span class="n">reconnect_count</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
              <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> *** WaitForIt CURRENT STATE </span><span class="se">\&quot;</span><span class="si">{:02}</span><span class="se">\&quot;</span><span class="s2"> TARGET STATE </span><span class="se">\&quot;</span><span class="si">{:02}</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
                      <span class="s2">&quot; *** WaitForIt working on transition</span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="s2">&quot; *** Current loop iteration </span><span class="se">\&quot;</span><span class="si">{:02}</span><span class="se">\&quot;</span><span class="s2">             - Reconnect attempts </span><span class="se">\&quot;</span><span class="si">{:02}</span><span class="se">\&quot;</span><span class="s2"> - loop_max </span><span class="se">\&quot;</span><span class="si">{:02}</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
                      <span class="s2">&quot; *** WaitForIt timeout interval </span><span class="se">\&quot;</span><span class="si">{:02}</span><span class="se">\&quot;</span><span class="s2"> seconds - Stale buffer check every </span><span class="se">\&quot;</span><span class="si">{:02}</span><span class="se">\&quot;</span><span class="s2"> times</span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="s2">&quot; *** WaitForIt variables </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
                      <span class="s2">&quot; *** WaitForIt Refresh=</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> Buffer Kicker=</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> - Kill Cord=</span><span class="se">\&quot;</span><span class="si">{:02}</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_state</span><span class="p">,</span>
                      <span class="n">x</span><span class="p">,</span> <span class="n">reconnect_count</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;loop_max&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span>
                      <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;expect_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;refresh&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;buffer_kicker&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_cord</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;loop_max&#39;</span><span class="p">]):</span>
              <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;last_try&#39;</span><span class="p">]:</span>
                <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendcontrol</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span>
                <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">expect_seq</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="n">last_try_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_it</span><span class="p">(</span><span class="n">my_r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">check_base_seq</span><span class="o">=</span><span class="n">base_seq</span><span class="p">,</span> <span class="n">check_expect_seq</span><span class="o">=</span><span class="n">expect_seq</span><span class="p">,</span>
                                               <span class="n">check_expect_dict</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;expect_dict&#39;</span><span class="p">])</span>
                  <span class="k">if</span> <span class="n">last_try_r</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">last_try_r</span><span class="p">,</span> <span class="n">reconnect_count</span>
                  <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">WaitForIt</span><span class="p">(</span><span class="n">expect_dict</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;expect_dict&#39;</span><span class="p">],</span> <span class="n">reconnect_count</span><span class="o">=</span><span class="n">reconnect_count</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                  <span class="k">raise</span> <span class="n">e</span>
              <span class="k">raise</span> <span class="n">WaitForIt</span><span class="p">(</span><span class="n">expect_dict</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;expect_dict&#39;</span><span class="p">],</span> <span class="n">reconnect_count</span><span class="o">=</span><span class="n">reconnect_count</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpTestSystem.check_it"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.check_it">[docs]</a>    <span class="k">def</span> <span class="nf">check_it</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;my_r&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;check_base_seq&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;check_expect_seq&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;check_expect_dict&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_vals</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">check_r</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;my_r&#39;</span><span class="p">]</span>
        <span class="n">check_expect_seq</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;check_expect_seq&#39;</span><span class="p">]</span>
        <span class="n">check_base_seq</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;check_base_seq&#39;</span><span class="p">]</span>
        <span class="n">check_expect_dict</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;check_expect_dict&#39;</span><span class="p">]</span>
        <span class="c1"># if we have a hit on the callers string process it</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">check_r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">check_base_seq</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_expect_seq</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
          <span class="c1"># if there is a handler callback</span>
          <span class="k">if</span> <span class="n">check_expect_dict</span><span class="p">[</span><span class="n">check_expect_seq</span><span class="p">[</span><span class="n">check_r</span><span class="p">]]:</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="c1"># this calls the handler callback, mostly intended for raising exceptions</span>
              <span class="n">check_expect_dict</span><span class="p">[</span><span class="n">check_expect_seq</span><span class="p">[</span><span class="n">check_r</span><span class="p">]](</span><span class="n">my_r</span><span class="o">=</span><span class="n">check_r</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">check_expect_seq</span><span class="p">[</span><span class="n">check_r</span><span class="p">])</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># future use, set this flag in a handler callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># if we go to a callback and get back here flag this to ignore the find</span>
                <span class="c1"># this allows special handling without interrupting the waiting for a good case</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
              <span class="c1"># if a callback handler raised an exception this will catch it and then re-raise it</span>
              <span class="k">raise</span> <span class="n">e</span>
          <span class="c1"># r based on sorted order of dict</span>
          <span class="k">return</span> <span class="n">check_r</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_base_seq</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">check_r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># EOF</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># while loop will get_console</span>
        <span class="c1"># we found nothing so return -1</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="OpTestSystem.run_REBOOT"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.run_REBOOT">[docs]</a>    <span class="k">def</span> <span class="nf">run_REBOOT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># allow login/setup</span>
        <span class="c1"># if run_REBOOT is used in the future outside of first time need to review previous_state handling</span>
        <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">target_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">target_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sys_set_bootdev_setup</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sys_set_bootdev_no_override</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">clear_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># block during reboot</span>
        <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;reboot&#39;</span><span class="p">)</span> <span class="c1"># connect will have the login/root setup_term done</span>
        <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">target_state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span><span class="p">):</span>
            <span class="n">my_r</span><span class="p">,</span> <span class="n">my_reconnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_it</span><span class="p">(</span><span class="n">expect_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">login_expect_table</span><span class="p">,</span>
               <span class="n">reconnect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">login_reconnect</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_login</span><span class="p">,</span> <span class="n">loop_max</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">my_r</span><span class="p">,</span> <span class="n">my_reconnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_it</span><span class="p">(</span><span class="n">expect_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petitboot_expect_table</span><span class="p">,</span>
               <span class="n">reconnect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petitboot_reconnect</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petitboot_refresh</span><span class="p">,</span> <span class="n">buffer_kicker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petitboot_kicker</span><span class="p">,</span>
               <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_petitboot</span><span class="p">,</span> <span class="n">loop_max</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
          <span class="k">return</span></div>

<div class="viewcode-block" id="OpTestSystem.run_UNKNOWN"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.run_UNKNOWN">[docs]</a>    <span class="k">def</span> <span class="nf">run_UNKNOWN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_power_off</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">POWERING_OFF</span></div>

<div class="viewcode-block" id="OpTestSystem.run_OFF"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.run_OFF">[docs]</a>    <span class="k">def</span> <span class="nf">run_OFF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OFF</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OFF</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnknownStateTransition</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;OpTestSystem in run_OFF and something caused the system to go to UNKNOWN&quot;</span><span class="p">)</span>

        <span class="c1"># We clear any possible errors at this stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_sdr_clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span><span class="p">:</span>
            <span class="c1"># By default auto-boot will be enabled, set no override</span>
            <span class="c1"># otherwise system endup booting in default disk.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sys_set_bootdev_no_override</span><span class="p">()</span>
            <span class="c1">#self.cv_IPMI.ipmi_set_boot_to_disk()</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sys_set_bootdev_setup</span><span class="p">()</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_power_on</span><span class="p">()</span>
        <span class="c1"># Only retry once</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_power_on</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span><span class="p">:</span>
                <span class="k">raise</span> <span class="s1">&#39;Failed powering on system&#39;</span>
        <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">IPLing</span></div>

<div class="viewcode-block" id="OpTestSystem.run_IPLing"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.run_IPLing">[docs]</a>    <span class="k">def</span> <span class="nf">run_IPLing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OFF</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sys_power_off</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">POWERING_OFF</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># if petitboot cannot be reached it will automatically increase the watermark and retry</span>
            <span class="c1"># see the tunables ipl_watermark and ipl_timeout for customization for extra long boot cycles for debugging, etc</span>
            <span class="n">petit_r</span><span class="p">,</span> <span class="n">petit_reconnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_it</span><span class="p">(</span><span class="n">expect_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petitboot_expect_table</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petitboot_reconnect</span><span class="p">,</span>
                <span class="n">buffer_kicker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petitboot_kicker</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_petitboot</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">petitboot_refresh</span><span class="p">,</span>
                <span class="n">loop_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ipl_watermark</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ipl_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HostbootShutdown</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sys_sel_check</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">WaitForIt</span><span class="p">,</span> <span class="n">HTTPCheck</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipl_watermark</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_cord</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">ipl_watermark</span> <span class="o">+=</span> <span class="mi">1</span>
              <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;OpTestSystem UNABLE TO REACH PETITBOOT or we missed it - </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">, increasing ipl_watermark for loop_max to </span><span class="si">{}</span><span class="s2">,&quot;</span>
                      <span class="s2">&quot; will re-IPL for another try&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipl_watermark</span><span class="p">))</span>
              <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN_BAD</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;OpTestSystem has reached the limit on re-IPL&#39;ing to try to recover, we will be stopping&quot;</span><span class="p">)</span>
              <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Exceptions like in OPexpect Assert fail</span>
            <span class="n">my_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;OpTestSystem in run_IPLing and the Exception=</span><span class="se">\n\&quot;</span><span class="si">{}</span><span class="se">\&quot;\n</span><span class="s2"> caused the system to&quot;</span>
                       <span class="s2">&quot; go to UNKNOWN_BAD and the system will be stopping.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">my_exception</span> <span class="o">=</span> <span class="n">UnknownStateTransition</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">my_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN_BAD</span>
            <span class="k">raise</span> <span class="n">my_exception</span>

        <span class="k">if</span> <span class="n">petit_r</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
          <span class="c1"># Once reached to petitboot check for any SEL events</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sys_sel_check</span><span class="p">()</span>
          <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span></div>

<div class="viewcode-block" id="OpTestSystem.run_PETITBOOT"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.run_PETITBOOT">[docs]</a>    <span class="k">def</span> <span class="nf">run_PETITBOOT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span><span class="p">:</span>
            <span class="c1"># verify that we are at the petitboot menu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_petitboot_shell</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_exit_to_shell</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OFF</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sys_power_off</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">POWERING_OFF</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">BOOTING</span>

        <span class="k">raise</span> <span class="n">UnknownStateTransition</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;OpTestSystem in run_PETITBOOT and something caused the system to go to UNKNOWN&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpTestSystem.run_PETITBOOT_SHELL"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.run_PETITBOOT_SHELL">[docs]</a>    <span class="k">def</span> <span class="nf">run_PETITBOOT_SHELL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">:</span>
            <span class="c1"># verify that we are at the petitboot shell</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">petitboot_exit_to_shell</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_petitboot_shell</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sys_power_off</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">POWERING_OFF</span></div>

<div class="viewcode-block" id="OpTestSystem.run_BOOTING"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.run_BOOTING">[docs]</a>    <span class="k">def</span> <span class="nf">run_BOOTING</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="c1"># if login cannot be reached it will automatically increase the watermark and retry</span>
          <span class="c1"># see the tunables booting_watermark and booting_timeout for customization for extra long boot cycles for debugging, etc</span>
          <span class="n">login_r</span><span class="p">,</span> <span class="n">login_reconnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_it</span><span class="p">(</span><span class="n">expect_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">login_expect_table</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">login_reconnect</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_login</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">login_refresh</span><span class="p">,</span> <span class="n">loop_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">booting_watermark</span><span class="p">,</span>
            <span class="n">fresh_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">login_fresh_start</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">booting_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">WaitForIt</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">booting_watermark</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_cord</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">booting_watermark</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;OpTestSystem UNABLE TO REACH LOGIN or we missed it - </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">, increasing booting_watermark for loop_max to </span><span class="si">{}</span><span class="s2">,&quot;</span>
                    <span class="s2">&quot; will re-IPL for another try&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">booting_watermark</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN_BAD</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;OpTestSystem has reached the limit on re-IPL&#39;ing to try to recover, we will be stopping&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">my_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;OpTestSystem in run_IPLing and Exception=</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> caused the system to&quot;</span>
                       <span class="s2">&quot; go to UNKNOWN_BAD and the system will be stopping.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">my_exception</span> <span class="o">=</span> <span class="n">UnknownStateTransition</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">my_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># hits like in OPexpect Assert fail</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN_BAD</span>
            <span class="k">raise</span> <span class="n">my_exception</span>

        <span class="k">if</span> <span class="n">login_r</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span></div>

<div class="viewcode-block" id="OpTestSystem.run_OS"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.run_OS">[docs]</a>    <span class="k">def</span> <span class="nf">run_OS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipmiDriversLoaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_power_off</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">POWERING_OFF</span></div>

<div class="viewcode-block" id="OpTestSystem.run_POWERING_OFF"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.run_POWERING_OFF">[docs]</a>    <span class="k">def</span> <span class="nf">run_POWERING_OFF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_wait_for_standby_state</span><span class="p">(</span><span class="n">BMC_CONST</span><span class="o">.</span><span class="n">SYSTEM_STANDBY_STATE_DELAY</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;System is in standby/Soft-off state&quot;</span>
        <span class="k">elif</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_PARAMETER</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Host Status sensor is not available/Skipping stand-by state check&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_msg</span> <span class="o">=</span> <span class="s2">&quot;System failed to reach standby/Soft-off state&quot;</span>
            <span class="k">raise</span> <span class="n">OpTestError</span><span class="p">(</span><span class="n">l_msg</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">SSHConnectionState</span><span class="o">.</span><span class="n">DISCONNECTED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">clear_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">OFF</span></div>

<div class="viewcode-block" id="OpTestSystem.load_ipmi_drivers"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.load_ipmi_drivers">[docs]</a>    <span class="k">def</span> <span class="nf">load_ipmi_drivers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipmiDriversLoaded</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Get OS level</span>
        <span class="n">l_oslevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_get_OS_Level</span><span class="p">()</span>

        <span class="c1"># Get kernel version</span>
        <span class="n">l_kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_get_kernel_version</span><span class="p">()</span>

        <span class="c1"># Checking for ipmitool command and package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_check_command</span><span class="p">(</span><span class="s2">&quot;ipmitool&quot;</span><span class="p">)</span>

        <span class="n">l_pkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_check_pkg_for_utility</span><span class="p">(</span><span class="n">l_oslevel</span><span class="p">,</span> <span class="s2">&quot;ipmitool&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Installed package: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">l_pkg</span><span class="p">)</span>

        <span class="c1"># loading below ipmi modules based on config option</span>
        <span class="c1"># ipmi_devintf, ipmi_powernv and ipmi_masghandler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_load_module_based_on_config</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">,</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">CONFIG_IPMI_DEVICE_INTERFACE</span><span class="p">,</span>
                                                      <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">IPMI_DEV_INTF</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_load_module_based_on_config</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">,</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">CONFIG_IPMI_POWERNV</span><span class="p">,</span>
                                                      <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">IPMI_POWERNV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_load_module_based_on_config</span><span class="p">(</span><span class="n">l_kernel</span><span class="p">,</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">CONFIG_IPMI_HANDLER</span><span class="p">,</span>
                                                      <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">IPMI_MSG_HANDLER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipmiDriversLoaded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;IPMI drivers loaded&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1">############################################################################</span>
    <span class="c1"># System Interfaces</span>
    <span class="c1">############################################################################</span>

<div class="viewcode-block" id="OpTestSystem.sys_sdr_clear"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_sdr_clear">[docs]</a>    <span class="k">def</span> <span class="nf">sys_sdr_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Clear all SDRs in the System</span>

<span class="sd">        Returns BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_sdr_clear</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">OpTestError</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">BMC_CONST</span><span class="o">.</span><span class="n">LONG_WAIT_IPL</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retry clearing SDR&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_sdr_clear</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
        <span class="k">return</span> <span class="n">rc</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_power_on"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_power_on">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Power on the host system, probably via `ipmitool power on`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_power_on</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
        <span class="k">return</span> <span class="n">rc</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_power_cycle"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_power_cycle">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Power cycle the host, most likely `ipmitool power cycle`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_power_cycle</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_power_soft"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_power_soft">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_soft</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Soft power cycle the system. This allows OS to gracefully shutdown</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_power_soft</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
        <span class="k">return</span> <span class="n">rc</span></div>

    <span class="c1">##</span>
    <span class="c1"># @brief Power off the system</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_power_off"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_power_off">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_power_off</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_set_bootdev_setup"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_set_bootdev_setup">[docs]</a>    <span class="k">def</span> <span class="nf">sys_set_bootdev_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_set_boot_to_petitboot</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_set_bootdev_no_override"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_set_bootdev_no_override">[docs]</a>    <span class="k">def</span> <span class="nf">sys_set_bootdev_no_override</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_set_no_override</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_power_reset"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_power_reset">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_power_reset</span><span class="p">()</span></div>

    <span class="c1">##</span>
    <span class="c1"># @brief Warm reset on the bmc system</span>
    <span class="c1">#</span>
    <span class="c1"># @return BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_warm_reset"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_warm_reset">[docs]</a>    <span class="k">def</span> <span class="nf">sys_warm_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_warm_reset</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
        <span class="k">return</span> <span class="n">rc</span></div>

    <span class="c1">##</span>
    <span class="c1"># @brief Cold reset on the bmc system</span>
    <span class="c1">#</span>
    <span class="c1"># @return BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_cold_reset_bmc"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_cold_reset_bmc">[docs]</a>    <span class="k">def</span> <span class="nf">sys_cold_reset_bmc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_cold_reset</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
        <span class="k">return</span> <span class="n">rc</span></div>

    <span class="c1">##</span>
    <span class="c1"># @brief Cold reset on the Host</span>
    <span class="c1">#</span>
    <span class="c1"># @return BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_host_cold_reset"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_host_cold_reset">[docs]</a>    <span class="k">def</span> <span class="nf">sys_host_cold_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">l_rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_bmc_power_on_validate_host</span><span class="p">()</span>
            <span class="k">if</span><span class="p">(</span><span class="n">l_rc</span> <span class="o">!=</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_cold_reset</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>

        <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span></div>

    <span class="c1">##</span>
    <span class="c1"># @brief Wait for boot to end based on serial over lan output data</span>
    <span class="c1">#</span>
    <span class="c1"># @return BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_ipl_wait_for_working_state"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_ipl_wait_for_working_state">[docs]</a>    <span class="k">def</span> <span class="nf">sys_ipl_wait_for_working_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i_timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipl_wait_for_working_state</span><span class="p">(</span><span class="n">i_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
        <span class="k">return</span> <span class="n">rc</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_wait_for_standby_state"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_wait_for_standby_state">[docs]</a>    <span class="k">def</span> <span class="nf">sys_wait_for_standby_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wait for system to reach standby or[S5/G2: soft-off]</span>

<span class="sd">        :param i_timeout: The number of seconds to wait for system to reach standby, i.e. How long to poll the ACPI sensor for soft-off state before giving up.</span>
<span class="sd">        :rtype: BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">l_rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_wait_for_standby_state</span><span class="p">(</span><span class="n">i_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
        <span class="k">return</span> <span class="n">l_rc</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_wait_for_os_boot_complete"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_wait_for_os_boot_complete">[docs]</a>    <span class="k">def</span> <span class="nf">sys_wait_for_os_boot_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wait for system boot to host OS, It uses OS Boot sensor</span>

<span class="sd">        :param i_timeout: The number of minutes to wait for IPL to complete or Boot time,</span>
<span class="sd">            i.e. How long to poll the OS Boot sensor for working state before giving up.</span>
<span class="sd">        :rtype: BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">l_rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_wait_for_os_boot_complete</span><span class="p">(</span><span class="n">i_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
        <span class="k">return</span> <span class="n">l_rc</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_sel_check"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_sel_check">[docs]</a>    <span class="k">def</span> <span class="nf">sys_sel_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i_string</span><span class="o">=</span><span class="s2">&quot;Transition to Non-recoverable&quot;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check for error during IPL that would result in test case failure</span>

<span class="sd">        :param i_string: string to search for</span>
<span class="sd">        :rtype: BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_sel_check</span><span class="p">(</span><span class="n">i_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
        <span class="k">return</span> <span class="n">rc</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_sel_elist"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_sel_elist">[docs]</a>    <span class="k">def</span> <span class="nf">sys_sel_elist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dump</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the sel elist to dump out</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_sel_elist</span><span class="p">(</span><span class="n">dump</span><span class="o">=</span><span class="n">dump</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span></div>

    <span class="c1">##</span>
    <span class="c1"># @brief Validates the partition and waits for partition to connect</span>
    <span class="c1">#        important to perform before all inband communications</span>
    <span class="c1">#</span>
    <span class="c1"># @return BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_bmc_power_on_validate_host"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_bmc_power_on_validate_host">[docs]</a>    <span class="k">def</span> <span class="nf">sys_bmc_power_on_validate_host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Check to see if host credentials are present</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">ip</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">l_msg</span> <span class="o">=</span> <span class="s2">&quot;Partition credentials not provided&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">l_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>

        <span class="c1"># Check if partition is active</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PingFunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">totalSleepTime</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_get_OS_Level</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Trying to recover partition after error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_power_off</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sys_cold_reset_bmc</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_power_on</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sys_check_host_status</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PingFunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">PING_RETRY_POWERCYCLE</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>

        <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span></div>


    <span class="c1">##</span>
    <span class="c1"># @brief This function reboots the system(Power off/on) and</span>
    <span class="c1">#        check for system status and wait for</span>
    <span class="c1">#        FW and Host OS Boot progress to complete.</span>
    <span class="c1">#</span>
    <span class="c1"># @return BMC_CONST.FW_SUCCESS or raise OpTestError</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_hard_reboot"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_hard_reboot">[docs]</a>    <span class="k">def</span> <span class="nf">sys_hard_reboot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Performing a IPMI Power OFF Operation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_power_off</span><span class="p">()</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_wait_for_standby_state</span><span class="p">(</span><span class="n">BMC_CONST</span><span class="o">.</span><span class="n">SYSTEM_STANDBY_STATE_DELAY</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;System is in standby/Soft-off state&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_PARAMETER</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Host Status sensor is not available&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping stand-by state check&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_msg</span> <span class="o">=</span> <span class="s2">&quot;System failed to reach standby/Soft-off state&quot;</span>
            <span class="k">raise</span> <span class="n">OpTestError</span><span class="p">(</span><span class="n">l_msg</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing a IPMI Power ON Operation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_power_on</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_check_host_status</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PingFunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">PING_RETRY_POWERCYCLE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span></div>

    <span class="c1">##</span>
    <span class="c1"># @brief This function will check for system status and wait for</span>
    <span class="c1">#        FW and Host OS Boot progress to complete.</span>
    <span class="c1">#</span>
    <span class="c1"># @return BMC_CONST.FW_SUCCESS or raise OpTestError</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_check_host_status"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_check_host_status">[docs]</a>    <span class="k">def</span> <span class="nf">sys_check_host_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_ipl_wait_for_working_state</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;System booted to working state&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_PARAMETER</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Host Status sensor is not available&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skip wait for IPL runtime check&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_msg</span> <span class="o">=</span> <span class="s2">&quot;System failed to boot&quot;</span>
            <span class="k">raise</span> <span class="n">OpTestError</span><span class="p">(</span><span class="n">l_msg</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_wait_for_os_boot_complete</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;System booted to Host OS&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_PARAMETER</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OS Boot sensor is not available&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skip wait for wait for OS boot complete check&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_msg</span> <span class="o">=</span> <span class="s2">&quot;System failed to boot Host OS&quot;</span>
            <span class="k">raise</span> <span class="n">OpTestError</span><span class="p">(</span><span class="n">l_msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span></div>

    <span class="c1">##</span>
    <span class="c1"># @brief Issue IPMI PNOR Reprovision request command</span>
    <span class="c1">#</span>
    <span class="c1"># @return BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_issue_ipmi_pnor_reprovision_request"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_issue_ipmi_pnor_reprovision_request">[docs]</a>    <span class="k">def</span> <span class="nf">sys_issue_ipmi_pnor_reprovision_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_run_command</span><span class="p">(</span><span class="n">BMC_CONST</span><span class="o">.</span><span class="n">HOST_IPMI_REPROVISION_REQUEST</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to issue ipmi pnor reprovision request&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span>
        <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span></div>

    <span class="c1">##</span>
    <span class="c1"># @brief Wait for IPMI PNOR Reprovision to complete(response to 00)</span>
    <span class="c1">#</span>
    <span class="c1"># @return BMC_CONST.FW_SUCCESS or BMC_CONST.FW_FAILED</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_wait_for_ipmi_pnor_reprovision_to_complete"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_wait_for_ipmi_pnor_reprovision_to_complete">[docs]</a>    <span class="k">def</span> <span class="nf">sys_wait_for_ipmi_pnor_reprovision_to_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">l_res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">60</span><span class="o">*</span><span class="n">timeout</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">l_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_HOST</span><span class="o">.</span><span class="n">host_run_command</span><span class="p">(</span><span class="n">BMC_CONST</span><span class="o">.</span><span class="n">HOST_IPMI_REPROVISION_PROGRESS</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;00&quot;</span> <span class="ow">in</span> <span class="n">l_res</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;IPMI: Reprovision completed&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">l_msg</span> <span class="o">=</span> <span class="s2">&quot;Reprovision timeout, progress not reaching to 00&quot;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">l_msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">OpTestError</span><span class="p">(</span><span class="n">l_msg</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_SUCCESS</span></div>

    <span class="c1">##</span>
    <span class="c1"># @brief This function gets the sel log</span>
    <span class="c1">#</span>
    <span class="c1"># @return sel list or BMC_CONST.FW_FAILED</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="OpTestSystem.sys_get_sel_list"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_get_sel_list">[docs]</a>    <span class="k">def</span> <span class="nf">sys_get_sel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">ipmi_get_sel_list</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">OpTestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BMC_CONST</span><span class="o">.</span><span class="n">FW_FAILED</span></div>

<div class="viewcode-block" id="OpTestSystem.petitboot_exit_to_shell"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.petitboot_exit_to_shell">[docs]</a>    <span class="k">def</span> <span class="nf">petitboot_exit_to_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
          <span class="n">pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_petitboot_prompt</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">pp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="n">pp</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;OpTestSystem detected something, tried to recover, but still we have a problem, retry&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConsoleSettings</span><span class="p">(</span><span class="n">before</span><span class="o">=</span><span class="n">sys_pty</span><span class="o">.</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">sys_pty</span><span class="o">.</span><span class="n">after</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;System at Petitboot Menu unable to exit to shell after retry&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpTestSystem.get_petitboot_prompt"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.get_petitboot_prompt">[docs]</a>    <span class="k">def</span> <span class="nf">get_petitboot_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">my_pp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span>
        <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>
        <span class="n">pes_rc</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="s2">&quot;.*#&quot;</span><span class="p">,</span> <span class="s2">&quot;.*# $&quot;</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pes_rc</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PS1_set</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SUDO_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOGIN_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PS1_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">set_PS1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span> <span class="n">sys_pty</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">build_prompt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">))</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">block_setup_term</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># unblock in case connections are lost during state=4 the get_console/connect can properly setup again</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">previous_state</span> <span class="o">=</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span> <span class="c1"># preserve state</span>
          <span class="n">my_pp</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="c1"># try new connect, sometimes stale buffers</span>
        <span class="k">return</span> <span class="n">my_pp</span></div>

<div class="viewcode-block" id="OpTestSystem.exit_petitboot_shell"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.exit_petitboot_shell">[docs]</a>    <span class="k">def</span> <span class="nf">exit_petitboot_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span>
        <span class="n">eps_rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_exit</span><span class="p">(</span><span class="n">sys_pty</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eps_rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Petitboot</span>
          <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># we timed out or eof</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">try_recover</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span> <span class="n">counter</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
          <span class="c1"># if we get back here we&#39;re good and at the prompt</span>
          <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>
          <span class="n">eps_rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_exit</span><span class="p">(</span><span class="n">sys_pty</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">eps_rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Petitboot</span>
            <span class="k">return</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RecoverFailed</span><span class="p">(</span><span class="n">before</span><span class="o">=</span><span class="n">sys_pty</span><span class="o">.</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">sys_pty</span><span class="o">.</span><span class="n">after</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Unable to get the Petitboot prompt stage 3, we were trying to exit back to menu&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpTestSystem.try_exit"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.try_exit">[docs]</a>    <span class="k">def</span> <span class="nf">try_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_pty</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">clear_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
          <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>
          <span class="n">sys_pty</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;exit&quot;</span><span class="p">)</span>
          <span class="n">rc_return</span> <span class="o">=</span> <span class="n">sys_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="s2">&quot;Petitboot&quot;</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">rc_return</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rc_return</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="OpTestSystem.get_my_ip_from_host_perspective"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.get_my_ip_from_host_perspective">[docs]</a>    <span class="k">def</span> <span class="nf">get_my_ip_from_host_perspective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">12340</span>
        <span class="n">my_ip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span> <span class="o">==</span> <span class="n">OpSystemState</span><span class="o">.</span><span class="n">PETITBOOT_SHELL</span><span class="p">:</span>
                <span class="n">raw_pty</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;nc -l -p </span><span class="si">%u</span><span class="s2"> -v -e /bin/true</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">raw_pty</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;nc -l -p </span><span class="si">%u</span><span class="s2"> -v</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;# Connecting to </span><span class="si">%s</span><span class="s2">:</span><span class="si">%u</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">()</span><span class="o">.</span><span class="n">hostname</span><span class="p">(),</span> <span class="n">port</span><span class="p">))</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">()</span><span class="o">.</span><span class="n">hostname</span><span class="p">(),</span> <span class="n">port</span><span class="p">))</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;Hello World!&#39;</span><span class="p">)</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">raw_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;Connection from &#39;</span><span class="p">)</span>
            <span class="n">raw_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">])</span>
            <span class="n">my_ip</span> <span class="o">=</span> <span class="n">raw_pty</span><span class="o">.</span><span class="n">before</span>
            <span class="n">raw_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">raw_pty</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">my_ip</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">my_ip</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Looks like older nc does not support -v, lets fallback</span>
            <span class="n">raw_pty</span><span class="o">.</span><span class="n">sendcontrol</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>  <span class="c1"># to avoid incase nc command hangs</span>
            <span class="n">my_ip</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s2">&quot;hostname -i&quot;</span><span class="p">)</span>
            <span class="n">ip_lst</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s2">&quot;hostname -I&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="c1"># Let&#39;s validate the IP</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ip_lst</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="n">ip</span><span class="p">:</span>
                    <span class="n">my_ip</span> <span class="o">=</span> <span class="n">ip</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">my_ip</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_lst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">my_ip</span> <span class="o">=</span> <span class="n">ip_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;hostname -i does not provide valid IP, correct and proceed with installation&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">my_ip</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_enable_tpm"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_enable_tpm">[docs]</a>    <span class="k">def</span> <span class="nf">sys_enable_tpm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">set_tpm_required</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_disable_tpm"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_disable_tpm">[docs]</a>    <span class="k">def</span> <span class="nf">sys_disable_tpm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">clear_tpm_required</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestSystem.sys_is_tpm_enabled"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestSystem.sys_is_tpm_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">sys_is_tpm_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_IPMI</span><span class="o">.</span><span class="n">is_tpm_enabled</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="OpTestFSPSystem"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestFSPSystem">[docs]</a><span class="k">class</span> <span class="nc">OpTestFSPSystem</span><span class="p">(</span><span class="n">OpTestSystem</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Implementation of an OpTestSystem for IBM FSP based systems (such as Tuleta and ZZ)</span>

<span class="sd">    Main differences are that some functions need to be done via the service processor</span>
<span class="sd">    rather than via IPMI due to differences in functionality.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bmc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">conf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">state</span><span class="o">=</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">):</span>
        <span class="n">bmc</span><span class="o">.</span><span class="n">fsp_get_console</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpTestFSPSystem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                                              <span class="n">bmc</span><span class="o">=</span><span class="n">bmc</span><span class="p">,</span>
                                              <span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">,</span>
                                              <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

<div class="viewcode-block" id="OpTestFSPSystem.sys_wait_for_standby_state"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestFSPSystem.sys_wait_for_standby_state">[docs]</a>    <span class="k">def</span> <span class="nf">sys_wait_for_standby_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_BMC</span><span class="o">.</span><span class="n">wait_for_standby</span><span class="p">(</span><span class="n">i_timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpTestFSPSystem.wait_for_it"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestFSPSystem.wait_for_it">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_it</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Ensure IPMI console is open so not to miss petitboot</span>
        <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_BMC</span><span class="o">.</span><span class="n">wait_for_runtime</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">OpTestFSPSystem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_it</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpTestFSPSystem.skiboot_log_on_console"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestFSPSystem.skiboot_log_on_console">[docs]</a>    <span class="k">def</span> <span class="nf">skiboot_log_on_console</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OpTestFSPSystem.has_host_accessible_eeprom"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestFSPSystem.has_host_accessible_eeprom">[docs]</a>    <span class="k">def</span> <span class="nf">has_host_accessible_eeprom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OpTestFSPSystem.has_host_led_support"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestFSPSystem.has_host_led_support">[docs]</a>    <span class="k">def</span> <span class="nf">has_host_led_support</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="OpTestFSPSystem.has_centaurs_in_dt"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestFSPSystem.has_centaurs_in_dt">[docs]</a>    <span class="k">def</span> <span class="nf">has_centaurs_in_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OpTestFSPSystem.has_mtd_pnor_access"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestFSPSystem.has_mtd_pnor_access">[docs]</a>    <span class="k">def</span> <span class="nf">has_mtd_pnor_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem">[docs]</a><span class="k">class</span> <span class="nc">OpTestOpenBMCSystem</span><span class="p">(</span><span class="n">OpTestSystem</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Implementation of an OpTestSystem for OpenBMC based platforms.</span>

<span class="sd">    Near all IPMI functionality is done via the OpenBMC REST interface instead.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bmc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">conf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">state</span><span class="o">=</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">):</span>
        <span class="c1"># Ensure we grab host console early, in order to not miss</span>
        <span class="c1"># any messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">bmc</span><span class="o">.</span><span class="n">get_host_console</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpTestOpenBMCSystem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                                                  <span class="n">bmc</span><span class="o">=</span><span class="n">bmc</span><span class="p">,</span>
                                                  <span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">,</span>
                                                  <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
    <span class="c1"># REST Based management</span>
<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_inventory"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_inventory">[docs]</a>    <span class="k">def</span> <span class="nf">sys_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">get_inventory</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_sensors"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_sensors">[docs]</a>    <span class="k">def</span> <span class="nf">sys_sensors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">sensors</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_bmc_state"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_bmc_state">[docs]</a>    <span class="k">def</span> <span class="nf">sys_bmc_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">get_bmc_state</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_power_on"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_power_on">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">power_on</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_power_off"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_power_off">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">power_off</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_power_reset"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_power_reset">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">hard_reboot</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_power_cycle"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_power_cycle">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">soft_reboot</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_power_soft"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_power_soft">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_soft</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#self.rest.power_soft() currently rest command for softPowerOff failing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">power_off</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_sdr_clear"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_sdr_clear">[docs]</a>    <span class="k">def</span> <span class="nf">sys_sdr_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">clear_sel</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_get_sel_list"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_get_sel_list">[docs]</a>    <span class="k">def</span> <span class="nf">sys_get_sel_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">list_sel</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_sel_elist"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_sel_elist">[docs]</a>    <span class="k">def</span> <span class="nf">sys_sel_elist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dump</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">get_sel_ids</span><span class="p">(</span><span class="n">dump</span><span class="o">=</span><span class="n">dump</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_sel_check"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_sel_check">[docs]</a>    <span class="k">def</span> <span class="nf">sys_sel_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">list_sel</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_wait_for_standby_state"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_wait_for_standby_state">[docs]</a>    <span class="k">def</span> <span class="nf">sys_wait_for_standby_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">wait_for_standby</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.wait_for_it"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.wait_for_it">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_it</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Ensure IPMI console is open so not to miss petitboot</span>
        <span class="n">sys_pty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">get_console</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">wait_for_runtime</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">OpTestOpenBMCSystem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">wait_for_it</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_set_bootdev_setup"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_set_bootdev_setup">[docs]</a>    <span class="k">def</span> <span class="nf">sys_set_bootdev_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">set_bootdev_to_setup</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_set_bootdev_no_override"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_set_bootdev_no_override">[docs]</a>    <span class="k">def</span> <span class="nf">sys_set_bootdev_no_override</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">set_bootdev_to_none</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_warm_reset"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_warm_reset">[docs]</a>    <span class="k">def</span> <span class="nf">sys_warm_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">bmc_reset</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_cold_reset_bmc"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_cold_reset_bmc">[docs]</a>    <span class="k">def</span> <span class="nf">sys_cold_reset_bmc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">bmc_reset</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_enable_tpm"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_enable_tpm">[docs]</a>    <span class="k">def</span> <span class="nf">sys_enable_tpm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">enable_tpm</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_disable_tpm"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_disable_tpm">[docs]</a>    <span class="k">def</span> <span class="nf">sys_disable_tpm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">disable_tpm</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestOpenBMCSystem.sys_is_tpm_enabled"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestOpenBMCSystem.sys_is_tpm_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">sys_is_tpm_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">is_tpm_enabled</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="OpTestQemuSystem"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestQemuSystem">[docs]</a><span class="k">class</span> <span class="nc">OpTestQemuSystem</span><span class="p">(</span><span class="n">OpTestSystem</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Implementation of OpTestSystem for the Qemu Simulator</span>

<span class="sd">    Running against a simulator is rather different than running against a machine,</span>
<span class="sd">    but only in some *specific* cases. Many tests will run as-is, but ones that require</span>
<span class="sd">    a bunch of manipulation of the BMC will likely not.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bmc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">conf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">state</span><span class="o">=</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">):</span>
        <span class="c1"># Ensure we grab host console early, in order to not miss</span>
        <span class="c1"># any messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">bmc</span><span class="o">.</span><span class="n">get_host_console</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">scratch_disk</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="n">host</span><span class="o">.</span><span class="n">scratch_disk</span> <span class="o">=</span> <span class="s2">&quot;/dev/sda&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpTestQemuSystem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                                               <span class="n">bmc</span><span class="o">=</span><span class="n">bmc</span><span class="p">,</span>
                                               <span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">,</span>
                                               <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

<div class="viewcode-block" id="OpTestQemuSystem.sys_wait_for_standby_state"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestQemuSystem.sys_wait_for_standby_state">[docs]</a>    <span class="k">def</span> <span class="nf">sys_wait_for_standby_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bmc</span><span class="o">.</span><span class="n">power_off</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="OpTestQemuSystem.sys_sdr_clear"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestQemuSystem.sys_sdr_clear">[docs]</a>    <span class="k">def</span> <span class="nf">sys_sdr_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="OpTestQemuSystem.sys_power_on"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestQemuSystem.sys_power_on">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bmc</span><span class="o">.</span><span class="n">power_on</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestQemuSystem.get_my_ip_from_host_perspective"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestQemuSystem.get_my_ip_from_host_perspective">[docs]</a>    <span class="k">def</span> <span class="nf">get_my_ip_from_host_perspective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;10.0.2.2&quot;</span></div>

<div class="viewcode-block" id="OpTestQemuSystem.has_host_accessible_eeprom"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestQemuSystem.has_host_accessible_eeprom">[docs]</a>    <span class="k">def</span> <span class="nf">has_host_accessible_eeprom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OpTestQemuSystem.has_mtd_pnor_access"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestQemuSystem.has_mtd_pnor_access">[docs]</a>    <span class="k">def</span> <span class="nf">has_mtd_pnor_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>

<div class="viewcode-block" id="OpTestMamboSystem"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestMamboSystem">[docs]</a><span class="k">class</span> <span class="nc">OpTestMamboSystem</span><span class="p">(</span><span class="n">OpTestSystem</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Implementation of OpTestSystem for the Mambo Simulator</span>

<span class="sd">    Running against a simulator is rather different than running against a machine,</span>
<span class="sd">    but only in some *specific* cases. Many tests will run as-is, but ones that require</span>
<span class="sd">    a bunch of manipulation of the BMC will likely not.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bmc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">conf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">state</span><span class="o">=</span><span class="n">OpSystemState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">):</span>
        <span class="c1"># Ensure we grab host console early, in order to not miss</span>
        <span class="c1"># any messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">bmc</span><span class="o">.</span><span class="n">get_host_console</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpTestMamboSystem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                                               <span class="n">bmc</span><span class="o">=</span><span class="n">bmc</span><span class="p">,</span>
                                               <span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">,</span>
                                               <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>

<div class="viewcode-block" id="OpTestMamboSystem.sys_wait_for_standby_state"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestMamboSystem.sys_wait_for_standby_state">[docs]</a>    <span class="k">def</span> <span class="nf">sys_wait_for_standby_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bmc</span><span class="o">.</span><span class="n">power_off</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="OpTestMamboSystem.sys_sdr_clear"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestMamboSystem.sys_sdr_clear">[docs]</a>    <span class="k">def</span> <span class="nf">sys_sdr_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="OpTestMamboSystem.sys_power_on"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestMamboSystem.sys_power_on">[docs]</a>    <span class="k">def</span> <span class="nf">sys_power_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bmc</span><span class="o">.</span><span class="n">power_on</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpTestMamboSystem.get_my_ip_from_host_perspective"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestMamboSystem.get_my_ip_from_host_perspective">[docs]</a>    <span class="k">def</span> <span class="nf">get_my_ip_from_host_perspective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OpTestMamboSystem.has_host_accessible_eeprom"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestMamboSystem.has_host_accessible_eeprom">[docs]</a>    <span class="k">def</span> <span class="nf">has_host_accessible_eeprom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OpTestMamboSystem.has_mtd_pnor_access"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestMamboSystem.has_mtd_pnor_access">[docs]</a>    <span class="k">def</span> <span class="nf">has_mtd_pnor_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OpTestMamboSystem.disable_stty_echo"><a class="viewcode-back" href="../../programming.html#common.OpTestSystem.OpTestMamboSystem.disable_stty_echo">[docs]</a>    <span class="k">def</span> <span class="nf">disable_stty_echo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># we do this here since we need it early in OpTestUtil</span>
        <span class="c1"># importing gets circular in OpTestUtil</span>
        <span class="c1"># we use OpTestUtil term_obj to get at the system attributes</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">op-test-framework</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=open-power&repo=op-test-framework&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/open-power/op-test-framework">
    <img
        alt="https://secure.travis-ci.org/open-power/op-test-framework.svg?branch=master"
        src="https://secure.travis-ci.org/open-power/op-test-framework.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide.html">op-test User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tests.html">The Tests</a></li>
</ul>
<p class="caption"><span class="caption-text">Programming Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../programming.html">Programming Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programming.html#generic-classes-modules">Generic Classes/Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programming.html#bmc-machine-specific">BMC/Machine Specific</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programming.html#module-testcases.OpTestFlash">Firmware Flashing</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, OpenPOWER Foundation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/open-power/op-test-framework" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>